from flask import Flask, send_file
from PIL import Image, ImageDraw
import datetime
import io

app = Flask(__name__)

def calculate_result_by_hashing(seed):
    # ì‚¬ìš©ìë‹˜ì˜ game.html ë‚´ BigInt í•´ì‹± ë¡œì§ì„ íŒŒì´ì¬ìœ¼ë¡œ ì™„ë²½ ì´ì‹
    # hash = BigInt(seed) * 16777619n
    hash_val = int(seed) * 16777619
    # hash = (hash ^ (hash >> 13n)) * 131n
    hash_val = (hash_val ^ (hash_val >> 13)) * 131
    # hash = (hash ^ (hash >> 15n))
    hash_val = (hash_val ^ (hash_val >> 15))
    
    hex_str = hex(hash_val).upper()
    last_char = hex_str[-1]
    
    try:
        last_digit = int(last_char, 16)
    except:
        last_digit = 0
        
    return "í™€" if last_digit % 2 != 0 else "ì§"

@app.route('/', defaults={'path': ''})
@app.route('/<path:path>')
def get_result(path):
    try:
        # 1. í•œêµ­ ì‹œê°„ ê³„ì‚°
        now = datetime.datetime.utcnow() + datetime.timedelta(hours=9)
        kst_ts_ms = int(now.timestamp() * 1000)
        
        # 2. 4ë¶„ ì£¼ê¸° (240,000ms)
        cycle_ms = 4 * 60 * 1000
        seed = kst_ts_ms // cycle_ms
        result_text = calculate_result_by_hashing(seed)
        
        # 3. ì´ë¯¸ì§€ ìƒì„± (game.html ë””ìì¸ ì¬í˜„)
        # ë°°ê²½ #f9f9f9, í¬ê¸° 400x320
        img = Image.new('RGB', (400, 320), color='#f9f9f9')
        d = ImageDraw.Draw(img)
        
        # 4. í°ìƒ‰ ì»¨í…Œì´ë„ˆ ë°°ê²½ ë° íŒŒë€ í…Œë‘ë¦¬ (border: 3px solid #4A90E2)
        d.rectangle([20, 20, 380, 300], fill="white", outline="#4A90E2", width=4)
        
        # 5. í—¤ë” (ğŸ² ì™€ì´ê³ ìˆ˜ 4ë¶„ì£¼ê¸° í™€ì§ ê²°ê³¼)
        d.text((80, 45), "ğŸ² YGOSU 4MIN RESULT", fill="#333333")
        
        # 6. ì¤‘ì•™ ê²°ê³¼ í‘œì‹œ (í™€/ì§)
        # í°íŠ¸ê°€ ì—†ìœ¼ë¯€ë¡œ ìƒ‰ìƒ ë°•ìŠ¤ë¡œ ê°•ì¡°
        res_color = "#e74c3c" if result_text == "í™€" else "#337ab7"
        d.rectangle([130, 85, 270, 165], fill=res_color)
        
        # ê²°ê³¼ í…ìŠ¤íŠ¸ (í•œê¸€ ê¹¨ì§ ë°©ì§€ë¥¼ ìœ„í•´ ODD/EVEN ë³‘ê¸° í˜¹ì€ ì˜ì–´ ì¶”ì²œí•˜ë‚˜, 
        # ì¼ë‹¨ ë¡œì§ í™•ì¸ì„ ìœ„í•´ ì˜ì–´ë¡œ í‘œê¸° - í•œê¸€ í°íŠ¸ ì¶”ê°€ ì „ê¹Œì§€ëŠ” ì˜ì–´ê°€ ì•ˆì „í•©ë‹ˆë‹¤)
        display_text = "ODD" if result_text == "í™€" else "EVEN"
        d.text((175, 115), display_text, fill="white")
        
        # 7. íƒ€ì´ë¨¸ (#timer ìŠ¤íƒ€ì¼)
        rem_sec = 240 - (int(now.timestamp()) % 240)
        timer_str = f"{rem_sec // 60:02d}:{rem_sec % 60:02d}"
        d.text((175, 185), timer_str, fill="#4A90E2")
        
        # 8. í•˜ë‹¨ ì •ë³´
        next_ts = (seed + 1) * cycle_ms
        next_dt = datetime.datetime.fromtimestamp(next_ts / 1000)
        d.text((130, 230), f"NEXT: {next_dt.strftime('%H:%M')}", fill="#666666")
        d.text((80, 270), "â€» SYNCED WITH EXTERNAL SERVER", fill="#999999")

        # 9. ì „ì†¡ (ìºì‹œ ë°©ì§€ ì ìš©)
        img_io = io.BytesIO()
        img.save(img_io, 'PNG')
        img_io.seek(0)
        return send_file(img_io, mimetype='image/png', max_age=0)
        
    except Exception as e:
        return str(e), 500
